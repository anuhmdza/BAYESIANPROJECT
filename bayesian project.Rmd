---
title: "BAYESIAN PROJECT"
author: "Ana Mendoza"
date: "2025-04-08"
output: word_document
---
load and clean the dataset 
```{r}
# Load your dataset
df <- read.csv("Autism Studies Dataset.csv")

# Keep only rows with both Sample Size and Number of Cases
df_clean <- df[!is.na(df$Sample.Size) & !is.na(df$Number.of.Cases), ]

# Rename for simplicity
df_clean$y <- df_clean$Number.of.Cases
df_clean$n <- df_clean$Sample.Size
```
prepare data for jags 
```{r}
# Build the data list for JAGS
data_list <- list(
  y = as.integer(df_clean$y),
  n = as.integer(df_clean$n),
  N = nrow(df_clean)
)
```
define and run jags model
```{r}
library(rjags)

# Model: Binomial likelihood with uniform prior on theta
model_string <- "
model {
  for (i in 1:N) {
    y[i] ~ dbin(theta[i], n[i])
    theta[i] ~ dbeta(1, 1)
  }
}
"

# Compile and run the model
jags_model <- jags.model(textConnection(model_string), data = data_list, n.chains = 3)
update(jags_model, 1000)  # Burn-in
samples <- coda.samples(jags_model, variable.names = c("theta"), n.iter = 5000)
```

plot posterior for one study 
```{r}
posterior_matrix <- as.matrix(samples)

# Plot histogram for theta[1]
hist(posterior_matrix[, 1],
     main = "Posterior Distribution for Study 1",
     xlab = "Prevalence Rate",
     col = "lightblue", border = "white")
```


Posterior Summary for All Studies
```{r}
# Summarize the posterior distributions
library(coda)

summary_stats <- summary(samples)
theta_stats <- summary_stats$statistics
theta_quantiles <- summary_stats$quantiles

# Combine and view as a data frame
posterior_summary <- data.frame(
  Mean = theta_stats[, "Mean"],
  SD = theta_stats[, "SD"],
  `2.5%` = theta_quantiles[, "2.5%"],
  `97.5%` = theta_quantiles[, "97.5%"]
)
head(posterior_summary)
```

 Plot Posterior Distributions for Multiple Studies
```{r}
 # Plot density estimates for first 5 studies
plot(density(posterior_matrix[,1]), main="Posterior Densities for First 5 Studies",
     xlab="Prevalence Rate", ylim=c(0, 15))
for (i in 2:5) {
  lines(density(posterior_matrix[,i]), col=i)
}
legend("topright", legend=paste("Study", 1:5), col=1:5, lty=1)
```
Estimate and Plot Overall Prevalence Rate (Pooled)
```{r}
# Estimate pooled prevalence
df_clean$p_hat <- df_clean$y / df_clean$n
pooled_p_hat <- sum(df_clean$y) / sum(df_clean$n)

# Plot histogram of p_hat with pooled prevalence
hist(df_clean$p_hat, breaks=20, main="Observed Proportions vs. Pooled",
     xlab="Observed Prevalence", col="skyblue", border="white")
abline(v = pooled_p_hat, col="red", lwd=2, lty=2)
legend("topright", legend=paste("Pooled:", round(pooled_p_hat, 3)), col="red", lty=2)
```
Check Convergence Diagnostics
```{r}
# Gelman-Rubin diagnostic
gelman_diag <- gelman.diag(samples)
print(gelman_diag)

# Traceplot for a few thetas
traceplot(samples[, 1:4])
```
Add a Hierarchical Beta-Binomial Model (Hyperprior)
```{r}
# Convert to matrix
hier_matrix <- as.matrix(samples_hier)

# 1. Summary of hyperparameters
alpha_post <- hier_matrix[, "alpha"]
beta_post <- hier_matrix[, "beta"]

cat("Posterior mean of alpha:", round(mean(alpha_post), 3), "\n")
cat("Posterior mean of beta:", round(mean(beta_post), 3), "\n")

# 2. Plot posterior for alpha and beta
par(mfrow=c(1,2))
hist(alpha_post, main="Posterior of alpha", col="lightcoral", xlab="alpha", border="white")
hist(beta_post, main="Posterior of beta", col="lightblue", xlab="beta", border="white")

# 3. Plot a few posterior theta distributions
par(mfrow=c(1,1))
plot(density(hier_matrix[, "theta[1]"]), main="Posterior Densities (Hierarchical Model)",
     xlab="Prevalence Rate", ylim=c(0, 15), col=1)
for (i in 2:5) {
  lines(density(hier_matrix[, paste0("theta[", i, "]")]), col=i)
}
legend("topright", legend=paste("Study", 1:5), col=1:5, lty=1)

```
Posterior Predictive Checks
```{r}
# Extend model to include replicated data for PPC
model_ppc <- "
model {
  for (i in 1:N) {
    y[i] ~ dbin(theta[i], n[i])
    y_rep[i] ~ dbin(theta[i], n[i])  # Replicated data
    theta[i] ~ dbeta(1, 1)
  }
}
"

data_list_ppc <- data_list
jags_ppc <- jags.model(textConnection(model_ppc), data = data_list_ppc, n.chains = 3)
update(jags_ppc, 1000)
ppc_samples <- coda.samples(jags_ppc, variable.names = c("y_rep"), n.iter = 5000)

# Extract y_rep matrix
y_rep_matrix <- as.matrix(ppc_samples)
y_rep_means <- colMeans(y_rep_matrix)

# Plot observed vs. predicted
plot(df_clean$y, y_rep_means, main="Posterior Predictive Check",
     xlab="Observed Cases", ylab="Predicted Cases", col="blue", pch=16)
abline(0, 1, col="red", lty=2)
```
Map Visualization by Country (if location data exists)
```{r}
library(ggplot2)
library(dplyr)
library(rnaturalearth)
library(rnaturalearthdata)

# If 'Country' exists, compute average posterior means per country
country_means <- df_clean %>%
  mutate(theta_mean = colMeans(posterior_matrix)) %>%
  group_by(Country) %>%
  summarise(MeanPrevalence = mean(theta_mean))

# World map data
world <- ne_countries(scale = "medium", returnclass = "sf")

# Merge with map
world_map <- left_join(world, country_means, by = c("name" = "Country"))

# Plot the map
ggplot(data = world_map) +
  geom_sf(aes(fill = MeanPrevalence)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  labs(title = "Estimated Autism Prevalence by Country",
       fill = "Prevalence") +
  theme_minimal()
```
